# AnimationTrigger 地震倒塌机制使用指南

本文档详细介绍了AnimationTrigger脚本中新增的地震倒塌机制功能，包括功能说明、设置方法和使用技巧。

## 功能概述

新增的地震倒塌机制实现了以下功能：

- 自动记录地震发生次数
- 当地震次数达到5次后，开始计算楼房倒塌概率（初始为20%）
- 之后每次地震，倒塌概率增加20%，直至达到100%
- 当触发倒塌时，自动在Final Canvas下实例化并显示死亡面板预制体
- 提供了调试和测试相关的辅助方法

## 设置方法

1. 在Unity编辑器中，找到已添加AnimationTrigger组件的游戏对象
2. 在Inspector面板中，配置以下参数：

### 动画设置

| 参数名称 | 说明 | 默认值 |
|---------|------|-------|
| windowObject | 挂载了Animation组件的窗口游戏对象 | 无（需要手动设置） |
| cameraObject | 挂载了Animation组件的相机游戏对象 | 无（需要手动设置） |

### 触发设置

| 参数名称 | 说明 | 默认值 |
|---------|------|-------|
| windowAnimationName | Animation组件中的窗口震动动画名称 | "windowshake" |
| cameraAnimationName | Animation组件中的相机地震动画名称 | "cameraEarthquake" |
| baseInterval | 基础间隔时间（秒） | 10 |
| randomVariation | 随机变化范围（秒） | 2 |

### 倒塌机制设置

| 参数名称 | 说明 | 默认值 |
|---------|------|-------|
| deadPanelPrefab | 死亡面板预制体引用 | 无（需要手动设置） |
| collapseStartThreshold | 开始计算倒塌概率的地震次数 | 5 |
| baseCollapseProbability | 基础倒塌概率（小数形式） | 0.2（20%） |
| probabilityIncrement | 每次增加的概率（小数形式） | 0.2（20%） |

3. 确保正确设置窗口和相机对象引用：
   - 这些对象必须挂载有Unity的Animation组件
   - 组件中必须存在与设置的动画名称相匹配的动画剪辑

4. 设置死亡面板预制体：
   - 在Inspector中直接拖入死亡面板预制体
   - 脚本会在触发倒塌时自动在场景中的"Final Canvas"下实例化并显示该预制体
   - 如果找不到"Final Canvas"，会使用默认方式实例化（这将在控制台输出警告）

## 概率计算规则

倒塌概率的计算公式如下：

```
当前倒塌概率 = 基础概率 + (地震次数 - 起始阈值) × 概率增量
```

并且概率上限为100%。

具体概率变化表：

| 地震次数 | 倒塌概率 |
|---------|--------|
| 1-4 | 0%（不触发倒塌） |
| 5 | 20% |
| 6 | 40% |
| 7 | 60% |
| 8 | 80% |
| 9及以上 | 100% |

## 调试与测试方法

为方便调试和测试，脚本提供了以下公共方法：

1. **TriggerAnimations()**：
   - 手动触发一次地震动画
   - 会增加地震计数并检查倒塌概率
   - 使用方法：在其他脚本中调用 `animationTrigger.TriggerAnimations()`

2. **GetEarthquakeCount()**：
   - 获取当前地震次数
   - 返回值：int类型的地震次数

3. **SetEarthquakeCount(int count)**：
   - 手动设置地震次数（用于快速测试特定次数下的行为）
   - 参数：count - 要设置的地震次数（必须为非负数）

4. **ResetAnimationCycle()**：
   - 重置地震次数并重新开始动画循环
   - 同时会清理已实例化的死亡面板
   - 可用于重新开始测试

## 调试日志

脚本包含详细的调试日志，可以在Unity编辑器的Console窗口中查看：

- 每次地震发生时，记录当前地震次数
- 计算倒塌概率时，记录当前概率值
- 触发倒塌时，记录倒塌事件和死亡面板实例化状态
- 手动设置地震次数时，记录设置结果

## 注意事项

1. 确保窗口和相机对象上正确挂载了Animation组件，并且包含正确名称的动画剪辑
2. 确保设置了有效的死亡面板预制体，否则倒塌时无法显示死亡界面
3. 地震次数会在游戏运行期间累积，除非调用ResetAnimationCycle()方法重置
4. 当触发倒塌后，地震动画会自动停止，需要手动重置才能重新开始
5. 死亡面板会被实例化在场景中的"Final Canvas"下，确保场景中存在此对象
6. 如果在测试中看不到死亡面板，请检查控制台日志是否有警告信息，确认Final Canvas是否存在

## 扩展建议

如果需要进一步扩展功能，可以考虑：

1. 添加倒塌时的特效和音效
2. 根据不同的倒塌原因显示不同的死亡信息
3. 实现倒塌后的重生机制
4. 添加玩家行为对倒塌概率的影响
5. 为死亡面板添加交互功能（如重新开始按钮）

---

通过以上设置和方法，您可以轻松实现地震次数累计和楼房倒塌的游戏机制，为游戏增加更多的挑战性和沉浸感。